package main

// import (
// 	"github.com/codecrafters-io/redis-starter-go/app/protocol"

// 	"fmt"
// 	"net"
// 	"reflect"
// 	"strconv"
// 	"strings"
// 	"sync"
// 	"testing"
// 	"time"
// )

// func readSingleLineResponse(conn net.Conn, t *testing.T) protocol.ASTNode {
// 	protocolInstance := protocol.NewProtocol(conn)
// 	RESPParsed, err := protocolInstance.ReadInput()

// 	if err != nil {
// 		t.Error(err)
// 	}

// 	return RESPParsed[0].AstNode
// }

// func startServer() (*Server, net.Conn) {
// 	var server *Server
// 	var wg sync.WaitGroup
// 	wg.Add(1)
// 	go func() {
// 		defer wg.Done()
// 		server = NewServer(WithPort("6379"))
// 	}()

// 	wg.Wait()

// 	conn, err := net.Dial("tcp", "127.0.0.1:6379")
// 	if err != nil {
// 		panic(fmt.Sprintf("connection err: %q", err))
// 	}

// 	return server, conn
// }

// func cleanup(server *Server, conn net.Conn) {
// 	m = map[string]CustomSetStore{}
// 	linkedList = map[string]*LinkedList{}
// 	conn.Close()
// 	server.Close()
// }

// func write(conn net.Conn, data []byte) {
// 	_, err := conn.Write(data)
// 	if err != nil {
// 		// dont need to handle them gracefully, it will be tested separately, we only need simple interface
// 		panic(fmt.Sprintf("write err: %q", err))
// 	}
// }

// func writeMany(conn net.Conn, data [][]byte) {
// 	protocolInstance := protocol.NewProtocol(conn)
// 	for _, item := range data {
// 		write(conn, item)

// 		_, err := protocolInstance.ReadInput()
// 		if err != nil {
// 			panic(err)
// 		}
// 	}
// }

// func TestCreateStream(t *testing.T) {
// 	server, conn := startServer()

// 	write(conn, []byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "1-1", "foo", "bar"})))
// 	node := readSingleLineResponse(conn, t)
// 	addStreamResp := node.(protocol.ASTBulkString).Val

// 	write(conn, []byte(BuildPrimitiveRESPArray([]string{"type", "key"})))
// 	node = readSingleLineResponse(conn, t)
// 	dataTypeResp := node.(protocol.ASTSimpleString).Val

// 	if dataTypeResp != StreamType {
// 		t.Errorf("Expected type to be: %v, got: %v", StreamType, dataTypeResp)
// 	}
// 	if addStreamResp != "1-1" {
// 		t.Errorf("expected steam id to be 1-1, got %v", addStreamResp)
// 	}

// 	cleanup(server, conn)

// }

// func TestCreateStreamWithDuplicate(t *testing.T) {
// 	server, conn := startServer()

// 	write(conn, []byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "1-1", "foo", "bar"})))
// 	node := readSingleLineResponse(conn, t)
// 	addStreamResp := node.(protocol.ASTBulkString).Val

// 	write(conn, []byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "1-1", "foo", "bar"})))
// 	node = readSingleLineResponse(conn, t)
// 	addDuplicateStreamErrResp := node.(protocol.ASTSimpleError)

// 	if addStreamResp != "1-1" {
// 		t.Errorf("expected streamId to be: %q, got:%q", "1-1", addStreamResp)
// 	}
// 	if addDuplicateStreamErrResp.Msg != "The ID specified in XADD is equal or smaller than the target stream top item" {
// 		t.Errorf("expected: %q, got:%q", "The ID specified in XADD is equal or smaller than the target stream top item", addDuplicateStreamErrResp.Msg)
// 	}
// 	if addDuplicateStreamErrResp.ErrType != "ERR" {
// 		t.Errorf("expected: %q, got:%q", "ERR", addDuplicateStreamErrResp.ErrType)
// 	}

// 	cleanup(server, conn)

// }

// func TestAutoGenerateStreamSequenceNumber(t *testing.T) {
// 	server, conn := startServer()

// 	write(conn, []byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "1-*", "foo", "bar"})))
// 	node := readSingleLineResponse(conn, t)
// 	addFirstStreamResp := node.(protocol.ASTBulkString).Val

// 	write(conn, []byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "1-*", "foo", "bar"})))
// 	node = readSingleLineResponse(conn, t)
// 	addSecondStreamResp := node.(protocol.ASTBulkString).Val

// 	if addFirstStreamResp != "1-0" {
// 		t.Errorf("expected: %q, got:%q", "$3\r\n1-0\r\n", addFirstStreamResp)
// 	}
// 	if addSecondStreamResp != "1-1" {
// 		t.Errorf("expected: %q, got:%q", "$3\r\n1-1\r\n", addFirstStreamResp)
// 	}

// 	cleanup(server, conn)
// }

// func TestAutoGenerateSequenceNumberWith0Prefix(t *testing.T) {
// 	server, conn := startServer()

// 	write(conn, []byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "0-*", "foo", "bar"})))
// 	node := readSingleLineResponse(conn, t)
// 	addFirstStreamResp := node.(protocol.ASTBulkString).Val

// 	write(conn, []byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "1-*", "foo", "bar"})))
// 	node = readSingleLineResponse(conn, t)
// 	addSecondStreamResp := node.(protocol.ASTBulkString).Val

// 	if addFirstStreamResp != "0-1" {
// 		t.Errorf("expected: %q, got:%q", "$3\r\n0-1\r\n", addFirstStreamResp)
// 	}
// 	if addSecondStreamResp != "1-0" {
// 		t.Errorf("expected: %q, got:%q", "$3\r\n1-0\r\n", addFirstStreamResp)
// 	}

// 	cleanup(server, conn)
// }

// func TestAutoGenerateSequenceAndTime(t *testing.T) {
// 	server, conn := startServer()

// 	write(conn, []byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "*", "foo", "bar"})))
// 	node := readSingleLineResponse(conn, t)
// 	addStreamResp := node.(protocol.ASTBulkString).Val

// 	responseSplitted := strings.Split(addStreamResp, "-")
// 	respTime := responseSplitted[0]
// 	respSequence := responseSplitted[1]
// 	currentTimeMili := time.Now().UnixMilli()
// 	timeTwoSecAgoMili := time.Now().Add(-2 * time.Second).UnixMilli()

// 	if strconv.FormatInt(currentTimeMili, 10) < respTime || strconv.FormatInt(timeTwoSecAgoMili, 10) > respTime {
// 		t.Errorf("time should be a bit before current and less than 2 seconds ago, current time:%v, two hours ago:%v, got time:%v", currentTimeMili, timeTwoSecAgoMili, respTime)
// 	}
// 	if respSequence != "0" {
// 		t.Errorf("expected sequence to be: %q, got:%q", "0", respSequence)
// 	}

// 	cleanup(server, conn)
// }

// func TestReadingStreamRangeWithinRanges(t *testing.T) {
// 	server, conn := startServer()
// 	streams := [][]byte{
// 		[]byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "0-1", "foo1", "bar1"})),
// 		[]byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "0-2", "foo2", "bar2"})),
// 		[]byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "0-3", "foo3", "bar3"})),
// 		[]byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "0-4", "foo4", "bar4"})),
// 	}

// 	writeMany(conn, streams)

// 	write(conn, []byte(BuildPrimitiveRESPArray([]string{"xrange", "key", "0-2", "0-4"})))
// 	RESPParsed := readSingleLineResponse(conn, t)
// 	respData := RESPParsed.(protocol.ASTArray).Values

// 	expectedData := []protocol.ASTNode{
// 		protocol.ASTArray{Values: []protocol.ASTNode{
// 			protocol.ASTBulkString{Val: "0-2"},
// 			protocol.ASTArray{Values: []protocol.ASTNode{
// 				protocol.ASTBulkString{Val: "foo2"},
// 				protocol.ASTBulkString{Val: "bar2"},
// 			}},
// 		}},
// 		protocol.ASTArray{Values: []protocol.ASTNode{
// 			protocol.ASTBulkString{Val: "0-3"},
// 			protocol.ASTArray{Values: []protocol.ASTNode{
// 				protocol.ASTBulkString{Val: "foo3"},
// 				protocol.ASTBulkString{Val: "bar3"},
// 			}},
// 		}},
// 		protocol.ASTArray{Values: []protocol.ASTNode{
// 			protocol.ASTBulkString{Val: "0-4"},
// 			protocol.ASTArray{Values: []protocol.ASTNode{
// 				protocol.ASTBulkString{Val: "foo4"},
// 				protocol.ASTBulkString{Val: "bar4"},
// 			}},
// 		}},
// 	}

// 	if !reflect.DeepEqual(respData, expectedData) {
// 		t.Errorf("Expected xrange to return nodes: %+v, got: %+v", expectedData, respData)
// 	}

// 	t.Cleanup(func() {
// 		conn.Close()
// 		m = map[string]CustomSetStore{}
// 		server.Close()
// 	})

// }

// func TestReadingStreamTillRange(t *testing.T) {
// 	server, conn := startServer()
// 	streams := [][]byte{
// 		[]byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "0-1", "foo1", "bar1"})),
// 		[]byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "0-2", "foo2", "bar2"})),
// 	}

// 	writeMany(conn, streams)

// 	write(conn, []byte(BuildPrimitiveRESPArray([]string{"xrange", "key", "-", "0-2"})))
// 	RESPParsed := readSingleLineResponse(conn, t)
// 	respData := RESPParsed.(protocol.ASTArray).Values

// 	expectedData := []protocol.ASTNode{
// 		protocol.ASTArray{Values: []protocol.ASTNode{
// 			protocol.ASTBulkString{Val: "0-1"},
// 			protocol.ASTArray{Values: []protocol.ASTNode{
// 				protocol.ASTBulkString{Val: "foo1"},
// 				protocol.ASTBulkString{Val: "bar1"},
// 			}},
// 		}},
// 		protocol.ASTArray{Values: []protocol.ASTNode{
// 			protocol.ASTBulkString{Val: "0-2"},
// 			protocol.ASTArray{Values: []protocol.ASTNode{
// 				protocol.ASTBulkString{Val: "foo2"},
// 				protocol.ASTBulkString{Val: "bar2"},
// 			}},
// 		}},
// 	}

// 	if !reflect.DeepEqual(respData, expectedData) {
// 		t.Errorf("Expected xrange to return nodes: %+v, got: %+v", expectedData, respData)
// 	}

// 	t.Cleanup(func() {
// 		conn.Close()
// 		m = map[string]CustomSetStore{}
// 		server.Close()
// 	})

// }

// func TestReadingStreamAllSequence(t *testing.T) {
// 	server, conn := startServer()
// 	streams := [][]byte{
// 		[]byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "0-1", "foo1", "bar1"})),
// 		[]byte(BuildPrimitiveRESPArray([]string{"xadd", "key", "0-2", "foo2", "bar2"})),
// 	}

// 	writeMany(conn, streams)

// 	write(conn, []byte(BuildPrimitiveRESPArray([]string{"xrange", "key", "0-0", "+"})))
// 	RESPParsed := readSingleLineResponse(conn, t)
// 	respData := RESPParsed.(protocol.ASTArray).Values

// 	expectedData := []protocol.ASTNode{
// 		protocol.ASTArray{Values: []protocol.ASTNode{
// 			protocol.ASTBulkString{Val: "0-1"},
// 			protocol.ASTArray{Values: []protocol.ASTNode{
// 				protocol.ASTBulkString{Val: "foo1"},
// 				protocol.ASTBulkString{Val: "bar1"},
// 			}},
// 		}},
// 		protocol.ASTArray{Values: []protocol.ASTNode{
// 			protocol.ASTBulkString{Val: "0-2"},
// 			protocol.ASTArray{Values: []protocol.ASTNode{
// 				protocol.ASTBulkString{Val: "foo2"},
// 				protocol.ASTBulkString{Val: "bar2"},
// 			}},
// 		}},
// 	}

// 	if !reflect.DeepEqual(respData, expectedData) {
// 		t.Errorf("Expected xrange to return nodes: %+v, got: %+v", expectedData, respData)
// 	}

// 	t.Cleanup(func() {
// 		conn.Close()
// 		m = map[string]CustomSetStore{}
// 		server.Close()
// 	})

// }

// //TODO: go back and fix this test
// // func TestReadingFromMultipleStreams(t *testing.T) {
// // 	server, conn := startServer()
// // 	streams := [][]byte{
// // 		[]byte(BuildPrimitiveRESPArray([]string{"xadd", "testStream", "0-1", "temperature", "96"})),
// // 	}

// // 	writeMany(conn, streams)

// // 	write(conn, []byte(BuildPrimitiveRESPArray([]string{"xread", "stream", "testStream", "0-1"})))
// // 	RESPParsed := readSingleLineResponse(conn, t)
// // 	respData := RESPParsed.(protocol.ASTArray).Values

// // 	expectedData := []protocol.ASTNode{
// // 		protocol.ASTArray{Values: []protocol.ASTNode{
// // 			protocol.ASTBulkString{Val: "testStream"},
// // 			protocol.ASTArray{Values: []protocol.ASTNode{
// // 				protocol.ASTBulkString{Val: "0-1"},
// // 				protocol.ASTArray{Values: []protocol.ASTNode{
// // 					protocol.ASTBulkString{Val: "temperature"},
// // 					protocol.ASTBulkString{Val: "96"},
// // 				}},
// // 			}},
// // 		}},
// // 	}

// // 	if !reflect.DeepEqual(respData, expectedData) {
// // 		t.Errorf("Expected xread to return nodes: %+v, got: %+v", expectedData, respData)
// // 	}

// // 	t.Cleanup(func() {
// // 		conn.Close()
// // 		m = map[string]CustomSetStore{}
// // 		server.Close()
// // 	})

// // }

// type SimpleASTTestCase struct {
// 	input  string
// 	output protocol.ASTNode
// }

// func (testCase SimpleASTTestCase) runTest(conn net.Conn, t *testing.T) {
// 	t.Run(fmt.Sprintf("Test RPUSH, for input: %v", testCase.input), func(t *testing.T) {
// 		write(conn, []byte(testCase.input))
// 		node := readSingleLineResponse(conn, t)
// 		if !reflect.DeepEqual(node, testCase.output) {
// 			t.Errorf("expected node to be: %q, got: %q", testCase.output, node)
// 		}
// 	})
// }

// func TestRPUSH(t *testing.T) {
// 	server, conn := startServer()

// 	testCaeses := []SimpleASTTestCase{
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"rpush", "list01", "item1"}),
// 			output: protocol.ASTNumber{Val: 1},
// 		},
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"rpush", "list01", "item2"}),
// 			output: protocol.ASTNumber{Val: 2},
// 		},
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"rpush", "list01", "item3"}),
// 			output: protocol.ASTNumber{Val: 3},
// 		},
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"rpush", "list02", "item1", "item2", "item3", "item4", "item5"}),
// 			output: protocol.ASTNumber{Val: 5},
// 		},
// 	}

// 	for _, testCase := range testCaeses {
// 		testCase.runTest(conn, t)
// 	}

// 	cleanup(server, conn)
// }

// func TestLrange(t *testing.T) {
// 	server, conn := startServer()
// 	streams := [][]byte{
// 		[]byte(BuildPrimitiveRESPArray([]string{"rpush", "list02", "item1", "item2", "item3", "item4", "item5"})),
// 	}
// 	writeMany(conn, streams)
// 	testCaeses := []SimpleASTTestCase{
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"lrange", "emptyList", "0", "2"}),
// 			output: protocol.ASTArray{Values: []protocol.ASTNode{}},
// 		},
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"lrange", "list02", "2", "1"}),
// 			output: protocol.ASTArray{Values: []protocol.ASTNode{}},
// 		},
// 		{
// 			input: BuildPrimitiveRESPArray([]string{"lrange", "list02", "0", "2"}),
// 			output: protocol.ASTArray{Values: []protocol.ASTNode{
// 				protocol.ASTBulkString{Val: "item1"},
// 				protocol.ASTBulkString{Val: "item2"},
// 				protocol.ASTBulkString{Val: "item3"},
// 			}},
// 		},
// 		{
// 			input: BuildPrimitiveRESPArray([]string{"lrange", "list02", "0", "10"}),
// 			output: protocol.ASTArray{Values: []protocol.ASTNode{
// 				protocol.ASTBulkString{Val: "item1"},
// 				protocol.ASTBulkString{Val: "item2"},
// 				protocol.ASTBulkString{Val: "item3"},
// 				protocol.ASTBulkString{Val: "item4"},
// 				protocol.ASTBulkString{Val: "item5"},
// 			}},
// 		},
// 		{
// 			input: BuildPrimitiveRESPArray([]string{"lrange", "list02", "-2", "-1"}),
// 			output: protocol.ASTArray{Values: []protocol.ASTNode{
// 				protocol.ASTBulkString{Val: "item4"},
// 				protocol.ASTBulkString{Val: "item5"},
// 			}},
// 		},

// 		{
// 			input: BuildPrimitiveRESPArray([]string{"lrange", "list02", "0", "-3"}),
// 			output: protocol.ASTArray{Values: []protocol.ASTNode{
// 				protocol.ASTBulkString{Val: "item1"},
// 				protocol.ASTBulkString{Val: "item2"},
// 				protocol.ASTBulkString{Val: "item3"},
// 			}},
// 		},

// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"lrange", "list02", "-6", "-8"}),
// 			output: protocol.ASTArray{Values: []protocol.ASTNode{}},
// 		},
// 	}

// 	for _, testCase := range testCaeses {
// 		testCase.runTest(conn, t)
// 	}

// 	cleanup(server, conn)
// }

// func TestLPUSH(t *testing.T) {
// 	server, conn := startServer()

// 	testCaeses := []SimpleASTTestCase{
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"lpush", "list01", "item1"}),
// 			output: protocol.ASTNumber{Val: 1},
// 		},
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"lpush", "list01", "item2"}),
// 			output: protocol.ASTNumber{Val: 2},
// 		},
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"lpush", "list02", "item1", "item2", "item3", "item4", "item5"}),
// 			output: protocol.ASTNumber{Val: 5},
// 		},
// 		{
// 			input: BuildPrimitiveRESPArray([]string{"lrange", "list01", "0", "2"}),
// 			output: protocol.ASTArray{Values: []protocol.ASTNode{
// 				protocol.ASTBulkString{Val: "item2"},
// 				protocol.ASTBulkString{Val: "item1"},
// 			}},
// 		},
// 		{
// 			input: BuildPrimitiveRESPArray([]string{"lrange", "list02", "0", "2"}),
// 			output: protocol.ASTArray{Values: []protocol.ASTNode{
// 				protocol.ASTBulkString{Val: "item5"},
// 				protocol.ASTBulkString{Val: "item4"},
// 				protocol.ASTBulkString{Val: "item3"},
// 			}},
// 		},
// 	}

// 	for _, testCase := range testCaeses {
// 		testCase.runTest(conn, t)
// 	}

// 	cleanup(server, conn)
// }

// func TestLlen(t *testing.T) {
// 	server, conn := startServer()
// 	streams := [][]byte{
// 		[]byte(BuildPrimitiveRESPArray([]string{"rpush", "list02", "item1", "item2", "item3", "item4", "item5"})),
// 	}
// 	writeMany(conn, streams)
// 	testCaeses := []SimpleASTTestCase{
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"llen", "emptyList"}),
// 			output: protocol.ASTNumber{Val: 0},
// 		},
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"llen", "list02"}),
// 			output: protocol.ASTNumber{Val: 5},
// 		},
// 	}

// 	for _, testCase := range testCaeses {
// 		testCase.runTest(conn, t)
// 	}

// 	cleanup(server, conn)
// }

// func TestLpop(t *testing.T) {
// 	server, conn := startServer()
// 	streams := [][]byte{
// 		[]byte(BuildPrimitiveRESPArray([]string{"rpush", "list02", "item1", "item2"})),
// 		[]byte(BuildPrimitiveRESPArray([]string{"rpush", "list03", "item1", "item2", "item3"})),
// 		[]byte(BuildPrimitiveRESPArray([]string{"rpush", "list04", "item1", "item2", "item3"})),
// 	}
// 	writeMany(conn, streams)
// 	testCaeses := []SimpleASTTestCase{
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"lpop", "list02"}),
// 			output: protocol.ASTBulkString{Val: "item1"},
// 		},
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"lpop", "list02"}),
// 			output: protocol.ASTBulkString{Val: "item2"},
// 		},
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"lpop", "list02"}),
// 			output: protocol.ASTBulkString{Val: ""},
// 		},
// 		{
// 			input:  BuildPrimitiveRESPArray([]string{"lpop", "noList01"}),
// 			output: protocol.ASTBulkString{Val: ""},
// 		},
// 		{
// 			input: BuildPrimitiveRESPArray([]string{"lpop", "list03", "3"}),
// 			output: protocol.ASTArray{
// 				Values: []protocol.ASTNode{
// 					protocol.ASTBulkString{Val: "item1"},
// 					protocol.ASTBulkString{Val: "item2"},
// 					protocol.ASTBulkString{Val: "item3"},
// 				},
// 			},
// 		},
// 		{
// 			input: BuildPrimitiveRESPArray([]string{"lpop", "list04", "0", "-1"}),
// 			output: protocol.ASTArray{
// 				Values: []protocol.ASTNode{
// 					protocol.ASTBulkString{Val: "item1"},
// 					protocol.ASTBulkString{Val: "item2"},
// 					protocol.ASTBulkString{Val: "item3"},
// 				},
// 			},
// 		},
// 	}

// 	for _, testCase := range testCaeses {
// 		testCase.runTest(conn, t)
// 	}

// 	cleanup(server, conn)
// }
